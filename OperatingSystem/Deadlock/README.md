# 교착 상태(Deadlock)

: 두 개 이상의 프로세스나 스레드가 서로 자원을 얻지 못해서 다음 처리를 하지 못하는 상태로 무한히 다음 자원을 기다리게 되는 상태를 말한다. (마치 외나무 다리에서 서로가 비켜주기를 기다리고 있는 상황)

## 1️⃣ 교착상태 발생 조건

: 아래 조건 중 하나라도 만족하지 않는다면 교착 상태가 발생하지 않지만, 모두 만족될 때 교착상태가 발생할 가능성이 생긴다.

1. **상호배제** : 해당 자원을 한 번에 하나의 프로세스만 사용 가능할 때
2. **점유와 대기** : 프로세스가 어떠한 자원을 할당받은 채 다른 자원을 할당받기를 기다릴 때
3. **비선점** : 다른 프로세스의 자원을 강제로 빼앗지 못할 때
4. **원형 대기** : 프로세스 집합에서 순환 형태로 자원을 대기하고 있을 때

## ✔ 교착상태 해결 방법

- 예방
- 회피
- 검출 후 회복

## 2️⃣ 교착상태 예방

: 교착 상태 발생 필요 조건 네 가지 중 하나를 충족하지 못하게 하는 것.

### 1. 상호배제 부정

: 모든 자원을 공유 가능하게 만든다는 뜻 => 현실성 떨어지는 방법

### 2. 점유와 대기 부정

: 운영체제는 특정 프로세스에게 자원을 모두 할당하거나 아예 할당하지 않는 방식으로 자원을 배분
=> 자원의 활용률이 낮아질 우려가 있음 => 많은 자원을 필요로 하는 프로세스가 무한정 기다리는 기아 현상 발생 가능

### 3. 비선점 부정

: 자원을 이용 중인 프로세스로부터 해당 자원을 빼앗을 수 있음 => 일부 자원에 대해서는 효과적이지만 모든 자원이 선점 가능한 것은 아니기 때문에 범용성이 떨어짐 (ex. 프린터)

### 4. 순환 대기 부정

: 모든 자원에 번호를 붙이고 오름차순으로 자원을 할당 => 비교적 현실적이고 실용적인 방식 => 그러나 수많은 자원에 번호를 붙이는 일은 간단한 작업이 아니고, 특정 자원의 활용률이 떨어질 수 있는 단점이 있음

=> 예방 방식은 교착 상태가 발생하지 않음을 보장할 수는 있지만 여러 부작용 들이 있음

## 3️⃣ 교착 상태 회피

: 교착 상태가 발생하지 않을 정도로만 자원을 할당하는 방식

- 프로세스들에 할당할 수 있는 자원이 한정된 상황에서 모든 프로세스들이 한 번에 많은 자원을 요구하면 교착 상태가 발생할 위험이 증가한다
- 프로세스들에 배분할 수 있는 자원의 양을 고려하여 교착 상태가 발생하지 않을 정도의 양만큼만 자원을 배분하는 방법이 교착 상태 회피 방법

<br>

- 안전 순서열 : 교착 상태 없이 안전하게 프로세스들에 자원을 할당할 수 있는 순서
- 안전 상태 : 안전 순서열이 있는 상태로, 교착상태가 발생하지 않고 모든 프로세스가 정상적으로 자원을 할당 받고 종료될 수 있는 상태
- 불안전 상태 : 안전 순서열이 없는 상태로 교착상태가 발생할 수 있는 위험이 있는 상태
- 은행원 알고리즘 : 다익스트라가 제안한 기법으로, 프로세스가 자원을 요구할 때, 시스템은 자원을 할당한 후에도 안정 상태로 남아있게 되는지 사전에 검사하여 교착 상태 회피, 안전 상태라면 자원 할당, 아니라면 다른 프로세스들이 자원 해지때까지 대기

### 🔆 은행원 알고리즘 예시

- 12개의 자원
- P1, P2, P3 3개의 프로세스
- 각각 5개, 2개, 2개의 자원을 사용 중
- | 프로세스 | 최대 요구량 | 현재사용량 | 요구량 |
  | -------- | ----------- | ---------- | ------ |
  | P1       | 10          | 5          | 5      |
  | P2       | 4           | 2          | 2      |
  | P3       | 9           | 2          | 7      |

- 할당 가능 자원 : 12
- 할당한 자원(P1, P2, P3 현재 사용량의 총합): 9
- 남은 자원(할당 가능 자원 - 할당한 자원) : 3
- 안전 순서열: P1 > P0 > P2
- P2은 이미 2개가 할당되어 있고, 2개를 요구하고 있음. 현재 남은 자원이 3개이므로, 이중에 2개를 P2에게 할당 => 현재 남은 자원은 3-2=1개
- 실행이 끝난 P2는 자원 4개를 모두 반납 => 현재 남은 자원은 1+4=5개
- 남은 자원이 5개이고, P1은 5개를 요구하기 때문에 P1에게 할당 => 현재 남은 자원 5-5=0
- 실행이 끝난 P1은 자원 10개를 모두 반납 => 남은 자원 0+10=10개
- 마지막으로 P3에게 자원 7개 할당 => 남은 자원 10-7=3개
- 실행이 끝난 P3는 자원 9개 반남 => 남은 자원 3+9=12개


## 4️⃣ 교착 상태 검출 후 회복

- 교착 상태 발생 후에 조치하는 방식
- 프로세스들이 자원을 요구할 때마다 그때그때 모두 할당하며, 교착 상태 발생 여부를 주기적으로 검사
- 교착 상태가 검출되면 그때 비로소 회복

### 1. 선점을 통한 회복

: 교착상태가 해결될 때까지 한 프로세스씩 자원을 몰아주는 방식으로, 프로세스가 점유하고 있는 자원을 선점해 다른 프로세스에게 할당

### 2. 프로세스 강제 종료를 통한 회복

- 가장 단순하면서 확실한 방법
- 교착 상태의 프로세스를 모두 중지시키면 교착 상태를 한 방에 해결할 수 있지만 그만큼 많은 프로세스들이 작업 내용을 읽게될 가능성이 있음
- 한 프로세스씩 강제 종료를 한다면, 교착 상태가 없어졌는지 여부를 확인하는 과정에서 오버헤드를 야기함
